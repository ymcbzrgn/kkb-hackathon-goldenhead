name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull latest code
        run: |
          cd /root/apps/kkb-hackathon-goldenhead
          git fetch origin main
          git reset --hard origin/main
          echo "üì• Code pulled successfully"

      - name: Update Backend Dependencies
        run: |
          cd /root/apps/kkb-hackathon-goldenhead/backend
          if [ -f "venv/bin/activate" ]; then
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            echo "üì¶ Backend dependencies updated"
          else
            echo "‚ö†Ô∏è Virtual environment not found, skipping pip install"
          fi

      - name: Run Database Migrations
        run: |
          cd /root/apps/kkb-hackathon-goldenhead/backend
          if [ -f "venv/bin/activate" ]; then
            source venv/bin/activate
            alembic upgrade head || echo "‚ö†Ô∏è Migration skipped or failed"
          fi

      - name: Update K8s TSG Scraper
        run: |
          if kubectl get namespace tsg-agent &> /dev/null; then
            echo "üîÑ Updating TSG Scraper image..."
            kubectl set image deployment/tsg-scraper \
              scraper=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/tsg-scraper:${{ github.sha }} \
              -n tsg-agent || echo "‚ö†Ô∏è TSG Scraper update skipped"

            # Wait for rollout
            kubectl rollout status deployment/tsg-scraper -n tsg-agent --timeout=120s || true
          else
            echo "‚ÑπÔ∏è tsg-agent namespace not found, skipping K8s update"
          fi

      - name: Update K8s ƒ∞hale Scraper
        run: |
          if kubectl get namespace ihale-agent &> /dev/null; then
            echo "üîÑ Updating ƒ∞hale Scraper image..."
            kubectl set image deployment/ihale-scraper \
              scraper=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ihale-scraper:${{ github.sha }} \
              -n ihale-agent || echo "‚ö†Ô∏è ƒ∞hale Scraper update skipped"

            kubectl set image deployment/ihale-ocr \
              ocr=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ihale-ocr:${{ github.sha }} \
              -n ihale-agent || echo "‚ö†Ô∏è ƒ∞hale OCR update skipped"

            kubectl rollout status deployment/ihale-scraper -n ihale-agent --timeout=120s || true
          else
            echo "‚ÑπÔ∏è ihale-agent namespace not found, skipping K8s update"
          fi

      - name: Update K8s News Scraper
        run: |
          if kubectl get namespace news-agent &> /dev/null; then
            echo "üîÑ Updating News Scraper image..."
            kubectl set image deployment/news-scraper \
              scraper=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/news-scraper:${{ github.sha }} \
              -n news-agent || echo "‚ö†Ô∏è News Scraper update skipped"

            kubectl rollout status deployment/news-scraper -n news-agent --timeout=120s || true
          else
            echo "‚ÑπÔ∏è news-agent namespace not found, skipping K8s update"
          fi

      - name: Update K8s LLM Gateway
        run: |
          if kubectl get namespace llm-gateway &> /dev/null; then
            echo "üîÑ Updating LLM Gateway image..."
            kubectl set image deployment/llm-gateway \
              gateway=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-gateway:${{ github.sha }} \
              -n llm-gateway || echo "‚ö†Ô∏è LLM Gateway update skipped"

            kubectl rollout status deployment/llm-gateway -n llm-gateway --timeout=120s || true
          else
            echo "‚ÑπÔ∏è llm-gateway namespace not found, skipping K8s update"
          fi

      - name: Restart Backend Services
        run: |
          cd /root/apps/kkb-hackathon-goldenhead

          # Restart API server if using systemd
          if systemctl is-active --quiet kkb-api; then
            sudo systemctl restart kkb-api
            echo "üîÑ API server restarted"
          fi

          # Restart Celery worker if using systemd
          if systemctl is-active --quiet kkb-celery; then
            sudo systemctl restart kkb-celery
            echo "üîÑ Celery worker restarted"
          fi

      - name: Health Check - API
        run: |
          echo "üè• Checking API health..."
          sleep 10

          # Try local API
          if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
            echo "‚úÖ API is healthy"
          else
            echo "‚ö†Ô∏è API health check failed or not running locally"
          fi

      - name: Health Check - TSG Scraper
        run: |
          echo "üè• Checking TSG Scraper health..."

          # Try K8s service
          if kubectl get svc tsg-scraper -n tsg-agent &> /dev/null; then
            TSG_POD=$(kubectl get pods -n tsg-agent -l app=tsg-scraper -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
            if [ -n "$TSG_POD" ]; then
              kubectl exec -n tsg-agent $TSG_POD -- curl -sf http://localhost:8080/health && echo "‚úÖ TSG Scraper is healthy" || echo "‚ö†Ô∏è TSG health check failed"
            fi
          else
            echo "‚ÑπÔ∏è TSG Scraper not deployed in K8s"
          fi

      - name: Deploy Summary
        run: |
          echo ""
          echo "=========================================="
          echo "üöÄ DEPLOY SUMMARY"
          echo "=========================================="
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Time: $(date)"
          echo "=========================================="
          echo "‚úÖ Deploy tamamlandƒ±!"
